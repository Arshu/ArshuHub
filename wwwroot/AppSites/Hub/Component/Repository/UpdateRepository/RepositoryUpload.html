
<div style="margin:5px;">

    <div style="margin: 0px 5px;position:relative;">
        <label for="appHubRepositoryUpdateSourceImagePath" class="ar-flex-item-stretch">Source Repository Name:Tag </label>
        {{HubRepositorySelect('RepositorySelectRefreshID':'appHubRepositoryUpdateSourceImagePathRefresh', 'RepositorySelectID':'appHubRepositoryUpdateSourceImagePath', 'RepositorySelectAction':'appHubRepositoryUpdateSourceImageAction', 'RepositorySelectConfig':'appHubRepositoryUpdateSourceImageConfig')}}
    </div>

    <div class="ar-flex-content-spaced">
        <label for="appHubRepositoryUpdateTargetImagePath" class="ar-flex-item-stretch">Target Repository Name:Tag</label>
    </div>

    <div class="ar-flex-input-wrap" style="margin: 5px;">
        <input id="appHubRepositoryUpdateTargetImagePath" class="ar-input ar-border ar-flex-item-stretch" style="padding-left: 5px;" type="text" placeholder="Your Target Image Name : Tag" value="" />
    </div>

    <div class="ar-flex-content-spaced">
        <label for="appHubRepositoryUpdateRepositoryType" class="ar-flex-item-stretch">Repository Type</label>
    </div>
    <div class="ar-flex-input-wrap">
        <select id="appHubRepositoryUpdateRepositoryType" class="ar-select ar-border ar-flex-item-stretch" style="padding-left:5px;" title="Machine Config List">
            {{@RepositoryTypeList}}
            <option {{@TypeSelect}} selected="selected" {{ /TypeSelect}} value="{{$TypeName}}">{{$TypeName}}</option>
            {{/RepositoryTypeList}}
        </select>
    </div>

    <div style="margin: 0px 5px;position:relative;">
        <label for="appHubRepositoryUpdateFolderList" class="ar-flex-item-stretch">Update Folder</label>
        {{HubRepositoryFolderSelect('RepositoryFolderSelectRefreshID':'appHubRepositoryUpdateFolderRefresh', 'RepositoryFolderSelectID':'appHubRepositoryUpdateFolderList', 'RepositoryFolderSelectType':'', 'RepositoryFolderSelectConfig': 'appHubRepositoryUpdateFolderConfig')}}
        <label class="ar-flex-item-stretch" style="margin: 5px 0px; text-align: center">
            Clear Before Update
            <input id="appHubRepositoryUpdateClearBeforeUpdate" type="checkbox" title="Clear Before Update" style="margin-left: 5px;" checked="checked">
        </label>
    </div>

    <span style="font-size:xx-small">Allowed Extensions:<span style="color:red;">{{$UploadWebAllowedExtension}}</span></span>
    <span style="font-size:xx-small">Max File Size : <span style="color:red;">{{$MaxFileSize}}</span></span>
    <div class="ar-flex-input-wrap" style="margin:5px;position:relative;">
        <button class="ar-button ar-border-left" style="width: 100px;">
            Zip File <br /><span style="font-size:xx-small">Max Size : <span style="color:red;">{{$MaxZipSize}}</span></span>
        </button>
        <label id="appHubRepositoryUpdateZipFileLabel" title="Choose Zip file" for="appHubRepositoryUpdateZipFile" style="font-size: 1.25em; font-weight: 700; color: black; display: inline-block;width:100%;position:absolute;">Choose Zip file</label>
        <div class="ar-flex-item-stretch ar-border-right" style="height: 39px;">
            <input id="appHubRepositoryUpdateZipFile" name="appHubRepositoryUpdateZipFile" class="ar-flex-item-stretch" style="width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; position: absolute; z-index: -1;" type="file">
            <script>
                document.getElementById("appHubRepositoryUpdateZipFile").addEventListener("change", setAppHubRepositoryUpdateZipFileLabel);
                function setAppHubRepositoryUpdateZipFileLabel(evt)
                {
                    if (this.files && this.files.length > 0)
                    {
                        let fileName = evt.target.value.split('\\').pop();
                        getElm('appHubRepositoryUpdateZipFileLabel').innerHTML = fileName;
                    }
                    else
                    {
                        getElm('appHubRepositoryUpdateZipFileLabel').innerHTML = getElm('appHubRepositoryUpdateZipFileLabel').title;
                    }
                }
            </script>
        </div>
    </div>

    <div class="ar-flex-content-wrap" style="margin: 5px;">
        <label class="ar-flex-item-stretch" style="margin: 5px 0px; text-align: center">
            Exclude AppData
            <input id="appHubRepositoryUpdateExcludeAppData" type="checkbox" title="Exclude App Data from Update" style="margin-left: 5px;" checked="checked">
        </label>

        <label class="ar-flex-item-stretch" style="margin: 5px 0px; text-align: center">
            Exclude AppConfig
            <input id="appHubRepositoryUpdateExcludeAppConfig" type="checkbox" title="Exclude App Config from Update" style="margin-left: 5px;" checked="checked">
        </label>

    </div>

    <fieldset class="ar-border" style="margin: 5px;position:relative;">
        <legend>Upload Admin Info</legend>

        <button class="ar-sbutton ar-border" style="position:absolute;right:0px;top:-10px;height:20px;font-size:xx-small;"
                onclick="clearUpdateDetails()">
            &#10060;
        </button>

        <span style="font-size:xx-small; color:red;display:block;">If repository updated with admin details, then repository can be modified only using same admin details</span>

        <div class="ar-flex-content-spaced">
            <label for="appHubRepositoryUpdateAdminUserID" class="ar-flex-item-stretch" onclick="let idElm = getElm('appHubRepositoryUpdateAdminUserID'); if (idElm.value =='') {idElm.value ='{{$OwnerEmail}}'} else {idElm.value =''}">Admin User ID</label>
        </div>

        <div class="ar-flex-input-wrap">
            <input id="appHubRepositoryUpdateAdminUserID" class="ar-input ar-border ar-flex-item-stretch" style="padding-left: 5px;" type="text" placeholder="Your Admin User Id" value="{{$OwnerEmail}}" />
        </div>

        <div class="ar-flex-content-spaced">
            <label for="appHubRepositoryUpdateAdminUserPassword" class="ar-flex-item-stretch" onclick="let passElm = getElm('appHubRepositoryUpdateAdminUserPassword');let passConfirmElm = getElm('appHubRepositoryUpdateAdminConfirmPassword');if (passElm.value =='') {passElm.value = '{{$OwnerPassword}}';passConfirmElm.value = '{{$OwnerPassword}}'} else {passElm.value ='';passConfirmElm.value =''}">Password</label>
            <label for="appHubRepositoryUpdateAdminConfirmPassword" class="ar-flex-item-stretch" onclick="let passElm = getElm('appHubRepositoryInitAdminUserPassword');let passConfirmElm = getElm('appHubRepositoryUpdateAdminConfirmPassword');if (passConfirmElm.value =='') {passElm.value = '{{$OwnerPassword}}'; passConfirmElm.value = '{{$OwnerPassword}}'} else {passElm.value ='';passConfirmElm.value =''}">Confirm Password</label>
        </div>

        <div class="ar-flex-input-wrap">
            <input id="appHubRepositoryUpdateAdminUserPassword" class="ar-input ar-border ar-flex-item-stretch" style="padding-left: 5px;" type="password" placeholder="Your Admin User Id" value="{{$OwnerPassword}}" />
            <div class="ar-flex-item-stretch" style="max-width:5px;"></div>
            <input id="appHubRepositoryUpdateAdminConfirmPassword" class="ar-input ar-border ar-flex-item-stretch" style="padding-left: 5px;" type="password" placeholder="Your Admin User Password" value="{{$OwnerPassword}}" />
        </div>

    </fieldset>

    <div class="ar-flex-content-wrap" style="margin:5px;">

        <button id="appHubRepositoryUpdateBtn" class="ar-button ar-border ar-flex-item-stretch" style="text-align: center; font-weight: bolder; color: black;"
                onclick="appHubUpdateRepository('appHubRepositoryUpdateProgress', 'appHubRepositoryUpdateResponse', getElm('appHubRepositoryUpdateAdminUserID').value, getElm('appHubRepositoryUpdateAdminUserPassword').value, getElm('appHubRepositoryUpdateAdminConfirmPassword').value, 'appHubRepositoryUpdateZipFile', getElm('appHubRepositoryUpdateFolderList').value, getElm('appHubRepositoryUpdateClearBeforeUpdate').checked, getElm('appHubRepositoryUpdateSourceImagePath').value, getElm('appHubRepositoryUpdateTargetImagePath').value, getElm('appHubRepositoryUpdateExcludeAppData').checked, getElm('appHubRepositoryUpdateExcludeAppConfig').checked, getElm('appHubRepositoryUpdateRepositoryType').value, 'appHubRepositoryUpdateBtn', 'appHubRepositoryUpdateDetailResponse')">
            Update Repository <span id="appHubRepositoryUpdateProgress"></span>
        </button>

    </div>

    <div id="appHubRepositoryUpdateResponseContainer" class="ar-notification" style="text-align:center;display:none;">
        <svg fill="currentColor" width="16px" height="16px" viewBox="0 0 32 32" xml:space="preserve"
             style="position:absolute;left:0px;top:0px;"
             onclick="toggleElm('appHubRepositoryUpdateDetailResponse')">
        <g>
        <path d="M17.962,24.725l1.806,0.096v2.531h-7.534v-2.406l1.045-0.094c0.568-0.063,0.916-0.254,0.916-1.014v-8.801
                 c0-0.699-0.188-0.92-0.791-0.92l-1.106-0.062v-2.626h5.666L17.962,24.725L17.962,24.725z M15.747,4.648
                 c1.394,0,2.405,1.047,2.405,2.374c0,1.331-1.014,2.313-2.438,2.313c-1.454,0-2.404-0.982-2.404-2.313
                 C13.31,5.695,14.26,4.648,15.747,4.648z M16,32C7.178,32,0,24.822,0,16S7.178,0,16,0c8.82,0,16,7.178,16,16S24.82,32,16,32z M16,3
                 C8.832,3,3,8.832,3,16s5.832,13,13,13s13-5.832,13-13S23.168,3,16,3z" />
             </g>
         </svg>
        <button class="ar-delete" onclick="hideElm('appHubRepositoryUpdateResponseContainer');hideElm('appHubRepositoryUpdateDetailResponse');"></button>
        <div id="appHubRepositoryUpdateResponse"></div>
        <div id="appHubRepositoryUpdateResponseWarn"></div>
    </div>

    <div id="appHubRepositoryUpdateDetailResponse" style="font-size:x-small;text-align:center;display:none;">
    </div>

</div>

<script type="text/javascript">

    function clearUpdateDetails() {
        getElm('appHubRepositoryUpdateAdminUserID').value = ""
        getElm('appHubRepositoryUpdateAdminUserPassword').value = ""
        getElm('appHubRepositoryUpdateAdminConfirmPassword').value = ""
    }

    function appHubRepositoryUpdateSourceImageAction()
    {
        triggerEvent('appHubRepositoryUpdateFolderRefresh', 'click');

        const date = new Date();
        const yyyy = date.getFullYear();
        const mm = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-based
        const dd = String(date.getDate()).padStart(2, '0');
        //let appendPrefix = 1;
        let appendPrefix = `${yyyy}${mm}${dd}`;

        let selectElm = getElm('appHubRepositoryUpdateSourceImagePath');
        let sourceNameTag = selectElm.value;
        if ((sourceNameTag.trim().length > 0) && (sourceNameTag.trim() != "0"))
        {
            const result = sourceNameTag.split(":");
            let repositoryName = result[0];
            let repositoryTag = result[1];

            let idxOfDash = result[0].indexOf("-");
            if (idxOfDash > -1)
            {
                let idxOfUnderscore = repositoryTag.indexOf("_");
                if (idxOfUnderscore == -1)
                {
                    appendPrefix = appendPrefix + "_1";
                }
                else
                {
                    let idxText = repositoryTag.substr(idxOfUnderscore + 1)
                    let idx = parseInt(idxText, 10)
                    if (idx != NaN)
                    {
                        appendPrefix = appendPrefix + "_" + (idx+1);
                    }else
                    {
                        appendPrefix = appendPrefix + "_1";
                    }
                }
                repositoryName = repositoryName.substr(0, idxOfDash);
            }

            let idxOfPrefix = result[1].indexOf(appendPrefix);
            if (idxOfPrefix > -1)
            {
                let idxOfUnderscore = repositoryTag.indexOf("_");
                if (idxOfUnderscore == -1)
                {
                    appendPrefix = appendPrefix + "_1";
                }
                else
                {
                    let idxText = repositoryTag.substr(idxOfUnderscore + 1)
                    let idx = parseInt(idxText, 10)
                    if (idx != NaN)
                    {
                        appendPrefix = appendPrefix + "_" + (idx+1);
                    }else
                    {
                        appendPrefix = appendPrefix + "_1";
                    }
                }
            }

            //getElm('appHubRepositoryUpdateTargetImagePath').value = repositoryName + "-"+ appendPrefix + ":" + repositoryTag;
            getElm('appHubRepositoryUpdateTargetImagePath').value = repositoryName + ":" + appendPrefix;
        }
        else
        {
            getElm('appHubRepositoryUpdateTargetImagePath').value = "";
        }
    }

    function appHubRepositoryUpdateSourceImageConfig()
    {
        let selectElm = getElm('appHubRepositoryUpdateSourceImagePath');
        let sourceNameTag = selectElm.value;
        return {"SelectedRepositoryPath": sourceNameTag};
    }

    function appHubRepositoryUpdateFolderConfig()
    {
        let selectElm = getElm('appHubRepositoryUpdateSourceImagePath');
        let sourceNameTag = selectElm.value;
        return {"SelectedRepositoryPath": sourceNameTag};
    }

    function appHubUpdateRepository(progressElmId, responseElmId, updateOwnerIDVal, updateOwnerPasswordVal, updateOwnerConfirmPasswordVal, fileElmId, updateFolderSelectVal, clearBeforeUpdateVal, sourceOCIImagePathVal, targetOCIImagePathVal, excludeAppDataVal, excludeAppConfigVal, repositoryTypeVal, actionBtnElmId, detailResponseElmId, successCallback, failureCallback) {
        let id = window.ajaxid++
        let responseElm = getElm(responseElmId)
        let responseContainerElmId = responseElmId + "Container"
        responseElm.textContent = ''
        hideElm(responseContainerElmId)

        var formData = new FormData()
        let valid = true

        if (valid === true) {
            if (updateOwnerIDVal.trim().length === 0) {
                showText(responseElm, 'Enter Owner ID', 'red')
                valid = false
            }
        }

        if (valid === true) {
            if (updateOwnerPasswordVal.trim().length === 0) {
                showText(responseElm, 'Enter Owner Password', 'red')
                valid = false
            }
        }

        if (valid === true) {
            if (updateOwnerConfirmPasswordVal.trim().length === 0) {
                showText(responseElm, 'Enter Owner Confirm Password', 'red')
                valid = false
            }
        }

        if (valid == true) {
            if (updateOwnerPasswordVal != updateOwnerConfirmPasswordVal) {
                showText(responseElm, 'Owner Password and Confirm Password does not match', 'red')
                valid = false
            }
        }

        if (valid == true) {
            var uploadFile = document.getElementById(fileElmId)
            if (uploadFile.files.length > 0) {
                formData.append("file", uploadFile.files[0])
            }
            else {
                showText(responseElm, 'Select a Zip File to Update', 'red')
                valid = false
            }
        }

        if (valid === true) {
            if (sourceOCIImagePathVal.trim().length === 0) {
                showText(responseElm, 'Select Source Repository to Update', 'red')
                valid = false
            }
            else if (sourceOCIImagePathVal.trim() =="0")
            {
                showText(responseElm, 'Select Source Repository to Update', 'red')
                valid = false
            }
        }

        if (valid === true) {
            if (targetOCIImagePathVal.trim().length === 0) {
                showText(responseElm, 'Enter Target Repository Path', 'red')
                valid = false
            }
            else
            {
                let idxOfColon = targetOCIImagePathVal.trim().indexOf(":");
                if (idxOfColon == -1)
                {
                    showText(responseElm, 'Enter Target Repository Path in [name:tag] format', 'red')
                    valid = false
                }
            }
        }

        if (valid == true) {
            if (updateFolderSelectVal == "") {
                showText(responseElm, 'Select the Layer Folder to Update', 'red')
                valid = false
            }
            else if (updateFolderSelectVal.trim() =="0")
            {
                showText(responseElm, 'Select the Layer Folder to Update', 'red')
                valid = false
            }
        }

        if (valid === true) {
            if (repositoryTypeVal.trim().length === 0) {
                showText(responseElm, 'Select Repository Type', 'red')
                valid = false
            }
            else if (repositoryTypeVal.trim() === "0") {
                showText(responseElm, 'Select Repository Type', 'red')
                valid = false
            }
        }

        if (valid == true) {
            getElm(actionBtnElmId).setAttribute("disabled", true)

            let refreshMode = ""
            let refreshDomain = ""

            let apiUrl = '/AppApi/HubApi'
            let apiMethod = 'RepositoryUpload'

            let apiParams = {
                "initOwnerID": updateOwnerIDVal,
                "initOwnerPassword": updateOwnerPasswordVal,
                "source_repository_info": sourceOCIImagePathVal,
                "target_repository_info": targetOCIImagePathVal,
                "repository_type" : repositoryTypeVal,
                "update_folder": updateFolderSelectVal,
                "clearBeforeUpdate": clearBeforeUpdateVal,
                "excludeAppData": excludeAppDataVal,
                "excludeAppConfig": excludeAppConfigVal
            }

            formData.append('FormDataMethod', apiMethod)
            for (const key in apiParams) {
                formData.append(key, apiParams[key])
            }

            let processReturn = function (result, responseElmId, successCallback, failureCallback) {

                let responseElm = getElm(responseElmId)

                getElm(actionBtnElmId).removeAttribute("disabled")

                if (result.hasOwnProperty('error') === true) {

                    showText(responseElm, result.error, 'red')

                    let detailMessageHtml = "";
                    let messageNo = 0;
                    if (result.hasOwnProperty('errorJson') === true) {
                        let errorJson = result.errorJson;
                        for (let i = 0; i < errorJson.length; i++) {
                            messageNo++;
                            let messageObj = errorJson[i];
                            for (var key in messageObj) {
                                if (messageObj.hasOwnProperty(key)) {
                                    detailMessageHtml = detailMessageHtml + messageNo + " : <span style='color:red'>" + messageObj[key] + "</span><br/>";
                                }
                            }
                        }
                    }
                    getElm(detailResponseElmId).innerHTML = detailMessageHtml;
                    showElm(detailResponseElmId);
                }
                else if (result.hasOwnProperty('message') === true) {

                    showText(responseElm, result.message, 'green')

                    if (result.hasOwnProperty('warn') === true) {
                        showText(responseWarnElm, result.warn, 'blue')                       
                    }

                    let detailMessageHtml = "";
                    let messageNo = 0;
                    if (result.hasOwnProperty('messageJson') === true) {
                        let messageJson = result.messageJson;
                        for (let i = 0; i < messageJson.length; i++) {
                            messageNo++;
                            let messageObj = messageJson[i];
                            for (var key in messageObj) {
                                if (messageObj.hasOwnProperty(key)) {
                                    detailMessageHtml = detailMessageHtml + messageNo + " : <span style='color:green'>" + messageObj[key] + "</span><br/>";
                                }
                            }
                        }
                    }
                    if (result.hasOwnProperty('warnJson') === true) {
                        let messageJson = result.warnJson;
                        for (let n = 0; n < messageJson.length; n++) {
                            messageNo++;
                            let messageObj = messageJson[n];
                            for (var key in messageObj) {
                                if (messageObj.hasOwnProperty(key)) {
                                    detailMessageHtml = detailMessageHtml + messageNo + " : <span style='color:blue'>" + messageObj[key] + "</span><br/>";
                                }
                            }
                        }
                    }
                    if (result.hasOwnProperty('errorJson') === true) {
                        let errorJson = result.errorJson
                        for (let i = 0; i < errorJson.length; i++) {
                            messageNo++
                            let messageObj = errorJson[i]
                            for (var key in messageObj) {
                                if (messageObj.hasOwnProperty(key)) {
                                    detailMessageHtml = detailMessageHtml + messageNo + " : <span style='color:red'>" + messageObj[key] + "</span><br/>"
                                }
                            }
                        }
                    }
                    getElm(detailResponseElmId).innerHTML = detailMessageHtml;
                    //showElm(detailResponseElmId);

                    if (typeof successCallback === "function") {
                        successCallback()
                    }
                }
                else if (result.hasOwnProperty('warn') === true) {

                    showText(responseElm, result.warn, 'red')

                    if (result.hasOwnProperty('warn') === true) {
                        showText(responseWarnElm, result.warn, 'blue')
                    }

                    let detailMessageHtml = "";
                    let messageNo = 0;
                    if (result.hasOwnProperty('warnJson') === true) {
                        let messageJson = result.warnJson;
                        for (let i = 0; i < messageJson.length; i++) {
                            messageNo++;
                            let messageObj = messageJson[i];
                            for (var key in messageObj) {
                                if (messageObj.hasOwnProperty(key)) {
                                    detailMessageHtml = detailMessageHtml + messageNo + " : <span style='color:blue'>" + messageObj[key] + "</span><br/>";
                                }
                            }
                        }
                    }
                    if (result.hasOwnProperty('errorJson') === true) {
                        let errorJson = result.errorJson
                        for (let i = 0; i < errorJson.length; i++) {
                            messageNo++
                            let messageObj = errorJson[i]
                            for (var key in messageObj) {
                                if (messageObj.hasOwnProperty(key)) {
                                    detailMessageHtml = detailMessageHtml + messageNo + " : <span style='color:red'>" + messageObj[key] + "</span><br/>"
                                }
                            }
                        }
                    }
                    getElm(detailResponseElmId).innerHTML = detailMessageHtml;
                    showElm(detailResponseElmId);
                }
            }

            callAssemblerUploadApi(progressElmId, responseElmId, apiUrl, apiMethod, formData, refreshMode, refreshDomain, processReturn, successCallback, failureCallback, 0, "{{$AppSite}}", "{{$AppView}}", "AppHub", "")
        }
    }

</script>


