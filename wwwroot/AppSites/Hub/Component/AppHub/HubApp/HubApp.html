
<div style="margin: 10px auto; padding:5px 0px; background-color: white;color:black;">

    <span style="font-size:xx-small">Allowed Extensions:<span style="color:blue;">{{$UploadWebAllowedExtension}}</span></span>
    <span style="font-size:xx-small">Max File Size : <span style="color:red;">{{$MaxFileSize}}</span></span>
    <div class="ar-flex-input-wrap" style="margin:0px 5px;position:relative;">
        <button class="ar-button ar-border-left" style="width: 100px;">
            Zip File <br /><span style="font-size:xx-small">Max Size : <span style="color:red;">{{$MaxZipSize}}</span></span>
        </button>
        <label id="appHubAppUpdateZipFileLabel" title="Choose Zip file" for="appHubAppUpdateZipFile" style="font-size: 1.25em; font-weight: 700; color: black; display: inline-block;width:100%;position:absolute">Choose Zip file</label>
        <div class="ar-flex-item-stretch ar-border-right" style="height: 39px;">
            <input id="appHubAppUpdateZipFile" name="appHubAppUpdateZipFile" class="ar-flex-item-stretch" style="width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; position: absolute; z-index: -1;" type="file">
            <script>
                document.getElementById("appHubAppUpdateZipFile").addEventListener("change", setAppHubAppUpdateZipFileLabel);
                function setAppHubAppUpdateZipFileLabel(evt)
                {
                    let illegalRe = /[\/\?<>\\:\*\|":]/g;
                    let controlRe = /[\x00-\x1f\x80-\x9f]/g;
                    let reservedRe = /^\.+$/;
                    let windowsReservedRe = /^(con|prn|aux|nul|com[0-9]|lpt[0-9])(\..*)?$/i;
                    let removechars = /[-_]/g;
                    let replacement = '';
                    if (this.files && this.files.length > 0)
                    {
                        let fileName = evt.target.value.split('\\').pop();
                        getElm('appHubAppUpdateZipFileLabel').innerHTML = fileName;
                        let sanitized = fileName
                            .replace(illegalRe, replacement)
                            .replace(controlRe, replacement)
                            .replace(reservedRe, replacement)
                            .replace(windowsReservedRe, replacement)
                            .replace(removechars, replacement);
                        let idxOfDot = sanitized.indexOf(".");
                        if (idxOfDot > 0)
                        {
                            getElm('appHubAppName').value = sanitized.substr(0, idxOfDot);
                        }
                        getElm('hubAppOwnerID').value ='';
                        getElm('hubAppOwnerPassword').value ='';
                    }
                    else
                    {
                        getElm('appHubAppUpdateZipFileLabel').innerHTML = getElm('appHubAppUpdateZipFileLabel').title;
                    }
                }
            </script>
        </div>
    </div>

    <div class="ar-flex-content-spaced" style="position:relative;">
        <label for="appHubAppName" class="ar-flex-item-stretch" onclick="let appElm = getElm('appHubAppName'); if (appElm.value =='') {appElm.value ='{{$TestAppName}}'} else {appElm.value =''}">App Name</label>
    </div>

    <div class="ar-flex-input-wrap" style="margin: 0px 5px;">
        <button style="width: 40px; text-align:center;" class="ar-button ar-border-left" onclick="openAppHubUrl()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
            </svg>
        </button>
        <input id="appHubAppName" class="ar-input ar-border-top-bottom ar-flex-item-stretch" style="padding-left: 5px;" type="text" placeholder="Your Target App Name (Sub Domain)" value="" />
        <button class="ar-button ar-border-right"
                onclick="getElm('appHubAppName').value ='';">
            &#10060;
        </button>
    </div>
    <span style="font-size:xx-small; color:red;display:block;">All Apps can be overwritten/deleted by others unless owner details specified in advanced options</span>

    <label style="font-size:xx-small;width:100%;">
        <input type="checkbox" id="showAdvanceOption" title="Show Advance Options" onclick="toggleElm('appAdvancedOptions');getElm('hubAppOwnerID').value =''; getElm('hubAppOwnerPassword').value ='';"> Advance Options
    </label>

    <div id="appAdvancedOptions" style="display:none;">

        <fieldset class="ar-border" style="position:relative;margin: 5px; padding-top:15px;">
            <legend>App Owner Info</legend>

            <button class="ar-sbutton ar-border" style="position:absolute;right:0px;top:-10px;height:20px;font-size:xx-small;"
                    onclick="getElm('hubAppOwnerID').value =''; getElm('hubAppOwnerPassword').value ='';">
                &#10060;
            </button>

            <div class="ar-flex-content-spaced">
                <label for="hubAppOwnerID" class="ar-flex-item-stretch" onclick="let idElm = getElm('hubAppOwnerID'); if (idElm.value =='') {idElm.value ='{{$OwnerEmail}}'} else {idElm.value =''}">Email</label>
                <label for="hubAppOwnerPassword" class="ar-flex-item-stretch" onclick="let passElm = getElm('hubAppOwnerPassword');if (passElm.value =='') {passElm.value = '{{$OwnerPassword}}'} else {passElm.value =''}">Password</label>
            </div>
            <div class="ar-flex-input-wrap" style="margin: 5px 0px;position:relative;">
                <input id="hubAppOwnerID" class="ar-input ar-border ar-flex-item-stretch " style="padding-left: 5px;" autocomplete="off" type="email" placeholder="App Owner Email" value="" />
                <div class="ar-flex-item-stretch" style="max-width:5px;"></div>
                <input id="hubAppOwnerPassword" class="ar-input ar-border ar-flex-item-stretch " style="padding-left: 5px;" autocomplete="off" type="password" placeholder="App Owner Password" value="" />
            </div>
        </fieldset>

        <div style="margin: 0px 5px;position:relative;">
            <label for="appHubRepositoryImagePath" class="ar-flex-item-stretch">Repository Template</label>
            {{HubAppTemplateSelect('RepositorySelectRefreshID':'appHubRepositoryImagePathRefresh', 'RepositorySelectID':'appHubRepositoryImagePath', 'RepositorySelectAction':'appHubRepositoryImagePathAction', 'RepositorySelectConfig':'appHubRepositoryImagePathConfig')}}
        </div>

    </div>
    
    <div id="appHubAppCreateResponseContainer" class="ar-notification" style="margin:5px; padding:10px;display:none;text-align:center;">
        <svg fill="currentColor" width="16px" height="16px" viewBox="0 0 32 32" xml:space="preserve"
             style="position:absolute;left:0px;top:0px;"
             onclick="toggleElm('appHubAppCreateDetailResponse')">
        <g>
        <path d="M17.962,24.725l1.806,0.096v2.531h-7.534v-2.406l1.045-0.094c0.568-0.063,0.916-0.254,0.916-1.014v-8.801
                 c0-0.699-0.188-0.92-0.791-0.92l-1.106-0.062v-2.626h5.666L17.962,24.725L17.962,24.725z M15.747,4.648
                 c1.394,0,2.405,1.047,2.405,2.374c0,1.331-1.014,2.313-2.438,2.313c-1.454,0-2.404-0.982-2.404-2.313
                 C13.31,5.695,14.26,4.648,15.747,4.648z M16,32C7.178,32,0,24.822,0,16S7.178,0,16,0c8.82,0,16,7.178,16,16S24.82,32,16,32z M16,3
                 C8.832,3,3,8.832,3,16s5.832,13,13,13s13-5.832,13-13S23.168,3,16,3z" />
             </g>
         </svg>
        <button class="ar-delete" onclick="hideElm('appHubAppCreateResponseContainer');hideElm('appHubAppCreateDetailResponse');"></button>
        <div id="appHubAppCreateResponse"></div>
        <div id="appHubAppCreateResponseWarn"></div>
    </div>

    <div id="appHubAppCreateDetailResponse" style="font-size:x-small;text-align:center;display:none;">
    </div>

    <div class="ar-flex-content-wrap" style="margin:5px;">

        <button id="appHubAppCreateBtn" class="ar-button ar-border ar-flex-item-stretch" style="text-align: center; font-weight: bolder; color: black;"
                onclick="createHubApp('appHubAppCreateProgress', 'appHubAppCreateResponse', getElm('hubAppOwnerID').value, getElm('hubAppOwnerPassword').value, getElm('appHubAppName').value, 'appHubAppUpdateZipFile', getElm('appHubRepositoryImagePath').value, 'appHubAppCreateBtn', 'appHubAppCreateDetailResponse')">
            Create App <span id="appHubAppCreateProgress"></span>
        </button>

    </div>

</div>

<script type="text/javascript">

    function appHubRepositoryImagePathAction()
    {
    }

    function appHubRepositoryImagePathConfig()
    {
        let selectElm = getElm('appHubRepositoryImagePath');
        let sourceNameTag = selectElm.value;
        return {"SelectedRepositoryPath": sourceNameTag};
    }

    function openAppHubUrl()
    {
        let inputElm = getElm('appHubAppName');
        let appName = inputElm.value.trim();
        if ((appName.length > 0) && (appName.indexOf(".") == -1))
        {
            if (window.location.hostname.toLowerCase() == 'localhost')
            {
                let url = window.location.href;
                if (url.endsWith("/") ==true)
                {
                    url = url + "reload";
                }else
                {
                    url = url + "/reload";
                }
                window.open(url, '_blank');
            }
            else
            {
                let host = window.location.host
                let hostArr = host.split('.')
                if (hostArr.length == 2)
                {
                    let url = window.location.protocol + "//" + appName + "." + window.location.host;                   
                    window.open(url, '_blank');
                }
                else if (hostArr.length == 3)
                {
                    let url = window.location.protocol + "//" + appName + "." + hostArr[1] + "." + hostArr[2];
                    if ((window.location.port != 80) && (window.location.port != 443))
                    {
                        url = url + ":" + window.location.port;
                    }
                    window.open(url, '_blank');
                }
            }
        }
    }

    function createHubApp(progressElmId, responseElmId, appOwnerIDVal, appOwnerPasswordVal, appNameVal, fileElmId, sourceOCIImagePathVal, actionBtnElmId, detailResponseElmId, successCallback, failureCallback) {
        let id = window.ajaxid++
        let responseElm = getElm(responseElmId)
        let responseContainerElmId = responseElmId + "Container"
        responseElm.textContent = ''
        hideElm(responseContainerElmId)

        var formData = new FormData()
        let valid = true

        // if (valid == true) {
        //     if (appOwnerIDVal.length == 0) {
        //         showText(responseElm, 'App Owner ID Cannot be Empty', 'red');
        //         valid = false;
        //     }
        // }

        // if (valid == true) {
        //     if (appOwnerPasswordVal.length == 0) {
        //         showText(responseElm, 'App Owner Password Cannot be Empty', 'red')
        //         valid = false
        //     }
        // }

        if (valid === true) {
            if (appNameVal.trim().length === 0) {
                showText(responseElm, 'Enter App Name', 'red')
                valid = false
            }
        }

        if (valid == true) {
            var uploadFile = document.getElementById(fileElmId)
            if (uploadFile.files.length > 0) {
                formData.append("file", uploadFile.files[0])
            }
            else {
                showText(responseElm, 'Select a Zip File to Update', 'red')
                valid = false
            }
        }

        if (valid === true) {
            if (sourceOCIImagePathVal.trim().length === 0) {
                showText(responseElm, 'Select Source Repository to Update', 'red')
                valid = false
            }
            else if (sourceOCIImagePathVal.trim() =="0")
            {
                showText(responseElm, 'Select Source Repository to Update', 'red')
                valid = false
            }
        }

        if (valid == true) {
            getElm(actionBtnElmId).setAttribute("disabled", true)

            let refreshMode = ""
            let refreshDomain = ""

            let apiUrl = '/AppApi/HubApi'
            let apiMethod = 'HubCreateApp'

            let apiParams = {
                "appOwnerID": appOwnerIDVal,
                "appOwnerPassword": appOwnerPasswordVal,
                "appName": appNameVal,
                "source_repository_info": sourceOCIImagePathVal
            }

            formData.append('FormDataMethod', apiMethod)
            for (const key in apiParams) {
                formData.append(key, apiParams[key])
            }

            let processReturn = function (result, responseElmId, successCallback, failureCallback) {

                let responseElm = getElm(responseElmId)

                getElm(actionBtnElmId).removeAttribute("disabled")

                if (result.hasOwnProperty('error') === true) {

                    showText(responseElm, result.error, 'red')

                    let detailMessageHtml = "";
                    let messageNo = 0;
                    if (result.hasOwnProperty('errorJson') === true) {
                        let errorJson = result.errorJson;
                        for (let i = 0; i < errorJson.length; i++) {
                            messageNo++;
                            let messageObj = errorJson[i];
                            for (var key in messageObj) {
                                if (messageObj.hasOwnProperty(key)) {
                                    detailMessageHtml = detailMessageHtml + messageNo + " : <span style='color:red'>" + messageObj[key] + "</span><br/>";
                                }
                            }
                        }
                    }
                    getElm(detailResponseElmId).innerHTML = detailMessageHtml;
                    showElm(detailResponseElmId);
                }
                else if (result.hasOwnProperty('message') === true) {

                    showText(responseElm, result.message, 'green')

                   if (result.hasOwnProperty('warn') === true) {
                        showText(responseWarnElm, result.warn, 'blue')                       
                    }

                    let detailMessageHtml = "";
                    let messageNo = 0;
                    if (result.hasOwnProperty('messageJson') === true) {
                        let messageJson = result.messageJson;
                        for (let i = 0; i < messageJson.length; i++) {
                            messageNo++;
                            let messageObj = messageJson[i];
                            for (var key in messageObj) {
                                if (messageObj.hasOwnProperty(key)) {
                                    detailMessageHtml = detailMessageHtml + messageNo + " : <span style='color:green'>" + messageObj[key] + "</span><br/>";
                                }
                            }
                        }
                    }
                    if (result.hasOwnProperty('warnJson') === true) {
                        let messageJson = result.warnJson;
                        for (let n = 0; n < messageJson.length; n++) {
                            messageNo++;
                            let messageObj = messageJson[n];
                            for (var key in messageObj) {
                                if (messageObj.hasOwnProperty(key)) {
                                    detailMessageHtml = detailMessageHtml + messageNo + " : <span style='color:blue'>" + messageObj[key] + "</span><br/>";
                                }
                            }
                        }
                    }
                    if (result.hasOwnProperty('errorJson') === true) {
                        let errorJson = result.errorJson
                        for (let i = 0; i < errorJson.length; i++) {
                            messageNo++
                            let messageObj = errorJson[i]
                            for (var key in messageObj) {
                                if (messageObj.hasOwnProperty(key)) {
                                    detailMessageHtml = detailMessageHtml + messageNo + " : <span style='color:red'>" + messageObj[key] + "</span><br/>"
                                }
                            }
                        }
                    }
                    getElm(detailResponseElmId).innerHTML = detailMessageHtml;
                    //showElm(detailResponseElmId);

                    if (typeof successCallback === "function") {
                        successCallback()
                    }
                }
                else if (result.hasOwnProperty('warn') === true) {

                    showText(responseElm, result.warn, 'red')

                    if (result.hasOwnProperty('warn') === true) {
                        showText(responseWarnElm, result.warn, 'blue')
                    }

                    let detailMessageHtml = "";
                    let messageNo = 0;
                    if (result.hasOwnProperty('warnJson') === true) {
                        let messageJson = result.warnJson;
                        for (let i = 0; i < messageJson.length; i++) {
                            messageNo++;
                            let messageObj = messageJson[i];
                            for (var key in messageObj) {
                                if (messageObj.hasOwnProperty(key)) {
                                    detailMessageHtml = detailMessageHtml + messageNo + " : <span style='color:blue'>" + messageObj[key] + "</span><br/>";
                                }
                            }
                        }
                    }
                    if (result.hasOwnProperty('errorJson') === true) {
                        let errorJson = result.errorJson
                        for (let i = 0; i < errorJson.length; i++) {
                            messageNo++
                            let messageObj = errorJson[i]
                            for (var key in messageObj) {
                                if (messageObj.hasOwnProperty(key)) {
                                    detailMessageHtml = detailMessageHtml + messageNo + " : <span style='color:red'>" + messageObj[key] + "</span><br/>"
                                }
                            }
                        }
                    }
                    getElm(detailResponseElmId).innerHTML = detailMessageHtml;
                    showElm(detailResponseElmId);
                }
            }

            callAssemblerUploadApi(progressElmId, responseElmId, apiUrl, apiMethod, formData, refreshMode, refreshDomain, processReturn, successCallback, failureCallback, 0, "{{$AppSite}}", "{{$AppView}}", "AppHub", "")
        }
    }

</script>


